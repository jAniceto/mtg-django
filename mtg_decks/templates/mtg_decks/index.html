{% extends "mtg_decks/base.html" %}
{% load static %}
{% load widget_tweaks %}


{% block content %}

<div class="container">

    <!-- Deck filtering -->
    <div id="filter-container" class="card mt-4">

        <!-- Card header -->
        <div class="card-header text-center">
            Filter decks
        </div>

        <!-- Card body -->
        <div class="card-body">

            <form id="deck-filter-form" 
                hx-get="{% url 'index' %}" 
                hx-target="#decks-container" 
                hx-trigger="submit" 
                hx-indicator="#filter-spinner" 
                hx-on::config-request="document.getElementById('filter-spinner').classList.remove('d-none');" 
                hx-on::after-request="document.getElementById('filter-spinner').classList.add('d-none');">

                <div class="row">
                    <div class="col-md-6">
                        <label for="{{ form.name.id_for_label }}" class="form-label">By name</label>
                        {{ form.name|add_class:"form-control" }}

                        <label for="{{ form.family.id_for_label }}" class="form-label mt-3">By guild/shard/clan</label>
                        {{ form.family|add_class:"form-select" }}
                    </div>

                    <div class="col-md-6">
                        <label for="{{ form.card.id_for_label }}" class="form-label">By card in mainboard</label>
                        {{ form.card|add_class:"form-control"|attr:"list:pauper-card-names"|attr:"autocomplete:off" }}
                        <datalist id="pauper-card-names"></datalist>

                        <label for="{{ form.tag.id_for_label }}" class="form-label mt-3">By tag</label>
                        {{ form.tag|add_class:"form-select" }}
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-10">
                        <button type="submit" class="btn btn-primary w-100">
                            <span id="filter-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Filter!
                        </button>
                    </div>

                    <div class="col-md-2">
                        <a href="{% url 'index' %}" type="button" class="btn btn-outline-primary w-100">Reset</a>
                    </div>
                </div>
    
            </form>

        </div>

    </div>


    <!-- Partial HTML with the forloop of decks -->
    <div id="decks-container">
        {% include 'mtg_decks/partials/decks.html' %}
    </div>

    <!-- Loading spinner for infinite scroll -->
    <div id="spinner" class="htmx-indicator d-flex justify-content-center mt-4">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Hidden field with decklist text -->
    <div id="decklist-text" class="d-none"></div>

</div>

{% endblock %}



{% block javascript %}

<script>
    // Create a list of pauper legal cards on the card input
    ////////////////////////////////////////////////////////
    
    // Get the <datalist> and <input> elements.
    const cardSearch = document.getElementById('id_card');
    const cardList = document.getElementById('pauper-card-names');

    // Function to fetch cards from Scryfall API
    async function fetchCards() {
        const query = cardSearch.value.trim();

        // Only send a request if there is input
        if (query.length === 0) {
            cardList.innerHTML = '';
            return;
        }

        try {
            const response = await fetch(`https://api.scryfall.com/cards/search?q=${query}+legal:pauper&unique=cards&order=name`);

            if (response.ok) {
                const data = await response.json();

                // Clear the list before adding new results
                cardList.innerHTML = '';

                // Populate the list with card names
                data.data.forEach(card => {
                    const listItem = document.createElement('option');
                    {% comment %} listItem.textContent = card.name; {% endcomment %}
                    listItem.value = card.name;
                    cardList.appendChild(listItem);
                });

            }
        } catch (error) {
            console.log(`${error.message}`);
        }
    }

    // Debounce function: Delays the execution of a function
    function debounce(func, delay) {
        let debounceTimeout;
        return function (...args) {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // Wrap fetchCards with debounce (300ms delay)
    const debouncedFetchCards = debounce(fetchCards, 300);

    // Add event listener to the input element to trigger the debounced function
    cardSearch.addEventListener('keyup', debouncedFetchCards);


    // Show card on hover
    ////////////////////////////////////////////////////////
    
    // Select all links with the class 'hover-link'
    const hoverLinks = document.querySelectorAll('.hover-link');

    // Function to show the image in the next sibling container
    function showImage(event) {
        // Get the image URL from the data attribute
        const imageUrl = event.target.getAttribute('data-image-url');

        // Find the next sibling element (the image container)
        const targetContainer = event.target.nextElementSibling;

        // Create an image element and set its src to the image URL
        const img = document.createElement('img');
        img.src = imageUrl;
        img.alt = 'Card Image';

        // Clear the target container's content and append the new image
        targetContainer.innerHTML = '';
        targetContainer.appendChild(img);
    }

    // Function to hide the image when the mouse leaves the link
    function hideImage(event) {
        // Find the next sibling element (the image container)
        const targetContainer = event.target.nextElementSibling;

        // Clear the image container content
        targetContainer.innerHTML = '';
    }

    // Because of HTMX infinite scroll, new loaded decks do not contain the event listener and will
    // not show images on hover. We need to attach event listeners on each new HTMX request for more decks.

    // Function to attach event listeners to hover links
    function attachListeners() {
        const hoverLinks = document.querySelectorAll('.hover-link');
        hoverLinks.forEach(link => {
            link.addEventListener('mouseover', showImage);
            link.addEventListener('mouseout', hideImage);
        });
    }

    // HTMX afterRequest callback: called after any HTMX request is completed
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        attachListeners(); // Re-attach event listeners after new content is loaded
    });

    // Initial setup to attach event listeners to existing links
    attachListeners();

</script>

{% endblock %}